<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ادامه فرآیند خرید - مزون کیمیا</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body{font-family:Tahoma,sans-serif;background:#f6f7fb;margin:0;padding:20px}
h2{text-align:center;color:#d63384;margin-bottom:20px}
#map{height:300px;border-radius:12px;margin-bottom:20px}
button{background:#d63384;color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;margin-top:10px}
.payment-options{max-width:900px;margin:auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);margin-bottom:20px;text-align:center}
</style>
</head>
<body>

<h2>ادامه فرآیند خرید</h2>

<div class="payment-options">
  <button id="currentLocationBtn">انتخاب مکان فعلی</button>
</div>

<div id="map"></div>

<div class="payment-options" id="paymentSection" style="display:none">
  <h3>روش پرداخت را انتخاب کنید:</h3>
  <button id="payOnDelivery">پرداخت در محل</button>
  <button id="payOnline">پرداخت آنلاین</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const CART_KEY='mezoun_kimia_cart';
const ORDERS_KEY='mezoun_kimia_orders';

function loadCart(){return JSON.parse(localStorage.getItem(CART_KEY)||'[]')}
function saveCart(c){localStorage.setItem(CART_KEY,JSON.stringify(c))}
function loadOrders(){return JSON.parse(localStorage.getItem(ORDERS_KEY)||'[]')}
function saveOrders(o){localStorage.setItem(ORDERS_KEY,JSON.stringify(o))}

// ---------- نقشه ----------
let selectedLatLng=null;
const map = L.map('map').setView([35.6892,51.3890],13); // تهران
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let marker=null;
map.on('click', function(e){
  selectedLatLng=e.latlng;
  if(marker) marker.setLatLng(e.latlng);
  else marker=L.marker(e.latlng).addTo(map);
  document.getElementById('paymentSection').style.display='block';
});

// ---------- انتخاب مکان فعلی ----------
document.getElementById('currentLocationBtn').onclick=()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude;
      const lng=pos.coords.longitude;
      selectedLatLng={lat,lng};
      map.setView([lat,lng],16);
      if(marker) marker.setLatLng([lat,lng]);
      else marker=L.marker([lat,lng]).addTo(map);
      document.getElementById('paymentSection').style.display='block';
    }, err=>alert('مکان‌یابی فعال نیست یا اجازه داده نشده'));
  }else alert('مکان‌یابی در مرورگر شما پشتیبانی نمی‌شود');
};

// ---------- انتخاب پرداخت ----------
document.getElementById('payOnDelivery').onclick=()=>{
  if(!selectedLatLng){alert('لطفا مکان خود را روی نقشه انتخاب کنید'); return}
  const cart=loadCart();
  if(!cart.length){alert('سبد خرید خالی است'); return}
  const order={items:cart,lat:selectedLatLng.lat,lng:selectedLatLng.lng,date:new Date().toLocaleString(),payment:'در محل'};
  const orders=loadOrders();
  orders.push(order);
  saveOrders(orders);
  saveCart([]);
  alert('سفارش شما ثبت شد. پرداخت در محل انجام خواهد شد.');
  location.href='index.html';
};

document.getElementById('payOnline').onclick=()=>{alert('پرداخت آنلاین هنوز فعال نیست');};
</script>

</body>
</html>
