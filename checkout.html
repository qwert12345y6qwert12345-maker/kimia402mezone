<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯ - Ù…Ø²ÙˆÙ† Ú©ÛŒÙ…ÛŒØ§</title>
  <style>
    body { font-family: sans-serif; direction: rtl; margin: 20px; background:#fafafa; }
    h2 { text-align: center; }
    #map { width: 100%; height: 400px; margin: 20px 0; border-radius: 12px; border:1px solid #ccc; }
    .section { background:#fff; padding:20px; margin:20px auto; max-width:600px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    button { padding: 10px 20px; border:none; background:#4CAF50; color:white; border-radius:8px; cursor:pointer; }
    button:hover { background:#45a049; }
    label { display:block; margin:10px 0; }
  </style>
  <!-- Ù„ÙˆØ¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù†Ù‚Ø´Ù‡ leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <h2>Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø®Ø±ÛŒØ¯</h2>

  <div class="section">
    <h3>Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø¯Ø±Ø³</h3>
    <button onclick="locateMe()">ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ</button>
    <div id="map"></div>
    <p id="selectedAddress" style="color:green;"></p>
  </div>

  <div class="section">
    <h3>Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
    <label><input type="radio" name="payment" value="cod"> Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ù…Ø­Ù„</label>
    <label><input type="radio" name="payment" value="online"> Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</label>
    <button onclick="completeOrder()">ØªÚ©Ù…ÛŒÙ„ Ø®Ø±ÛŒØ¯</button>
  </div>

  <script>
    // Ù†Ù‚Ø´Ù‡
    let map = L.map('map').setView([35.6892, 51.3890], 12); // Ù¾ÛŒØ´ÙØ±Ø¶ ØªÙ‡Ø±Ø§Ù†
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    let marker;

    // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø¯Ø±Ø³
    map.on('click', function(e) {
      if (marker) map.removeLayer(marker);
      marker = L.marker(e.latlng).addTo(map);
      document.getElementById("selectedAddress").textContent = 
        "Ø¢Ø¯Ø±Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: " + e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
      localStorage.setItem("selectedAddress", JSON.stringify(e.latlng));
    });

    // Ø¯Ú©Ù…Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ
    function locateMe(){
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          map.setView([lat,lng], 15);
          if (marker) map.removeLayer(marker);
          marker = L.marker([lat,lng]).addTo(map);
          document.getElementById("selectedAddress").textContent = 
            "Ø¢Ø¯Ø±Ø³ (Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ): " + lat.toFixed(5) + ", " + lng.toFixed(5);
          localStorage.setItem("selectedAddress", JSON.stringify({lat,lng}));
        }, ()=>alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ Ù…Ù‚Ø¯ÙˆØ± Ù†ÛŒØ³Øª"));
      } else {
        alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
      }
    }

    // ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´
    function completeOrder(){
      const pay = document.querySelector('input[name="payment"]:checked');
      if(!pay){ alert("Ù„Ø·ÙØ§ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯"); return; }

      const addr = localStorage.getItem("selectedAddress");
      if(!addr){ alert("Ù„Ø·ÙØ§ Ø¢Ø¯Ø±Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯"); return; }

      if(pay.value === "cod"){
        alert("Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯ âœ… (Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ù…Ø­Ù„)");
        // Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±
        saveOrder("Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ù…Ø­Ù„");
      } else if(pay.value === "online"){
        alert("Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡ Ø´Ø§Ù¾Ø±...");
        // Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ù…Ù‚ØµØ¯
        const cardNumber = "60371425367854";
        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ø´Ø§Ù¾Ø±Ú©
        window.location.href = `https://www.shaparak.ir/payment?amount=100000&card=${cardNumber}`;
      }
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ø³ÙØ§Ø±Ø´ Ø¯Ø± localStorage (Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±)
    function saveOrder(method){
      let orders = JSON.parse(localStorage.getItem("orders")||"[]");
      let cart = JSON.parse(localStorage.getItem("cart")||"[]");
      let addr = JSON.parse(localStorage.getItem("selectedAddress"));
      orders.push({
        items: cart,
        address: addr,
        payment: method,
        date: new Date().toLocaleString()
      });
      localStorage.setItem("orders", JSON.stringify(orders));
      localStorage.removeItem("cart"); // Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯
      alert("Ø³ÙØ§Ø±Ø´ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ú¯Ø±Ø¯ÛŒØ¯ âœ…");
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
